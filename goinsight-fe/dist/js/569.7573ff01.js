"use strict";(self["webpackChunkvue_antd_pro"]=self["webpackChunkvue_antd_pro"]||[]).push([[569],{7569:function(e,t,r){r.r(t),r.d(t,{default:function(){return b}});r(68309);var a=function(){var e=this,t=e._self._c;return t("div",[t("a-card",{attrs:{title:e.cardTitle}},[t("a-row",{attrs:{gutter:{xs:8,sm:16,md:24,lg:32}}},[t("a-col",{staticClass:"gutter-row",attrs:{span:8}},[t("a-card",[t("a-form",{ref:"formHeight",attrs:{form:e.form,"label-col":{span:6},"wrapper-col":{span:18}}},[t("a-form-item",{attrs:{label:"标题","has-feedback":""}},[t("a-input",{directives:[{name:"decorator",rawName:"v-decorator",value:["title",{rules:[{required:!0,min:5,max:96}],validateTrigger:"blur"}],expression:"[\n                  'title',\n                  {\n                    rules: [{ required: true, min: 5, max: 96 }],\n                    validateTrigger: 'blur',\n                  },\n                ]"}],attrs:{placeholder:"请输入工单标题"}})],1),t("a-form-item",{attrs:{label:"备注","has-feedback":""}},[t("a-textarea",{directives:[{name:"decorator",rawName:"v-decorator",value:["remark"],expression:"['remark']"}],attrs:{"auto-size":{minRows:2,maxRows:6},placeholder:"请输入工单需求或备注"}})],1),t("a-form-item",{attrs:{label:"限制访问",help:"开启后仅工单的提交人/审核人/复核人/抄送人可以查看工单内容"}},[t("a-select",{directives:[{name:"decorator",rawName:"v-decorator",value:["is_restrict_access",{initialValue:"YES",rules:[{required:!0,message:"是否限制访问"}]}],expression:"[\n                  'is_restrict_access',\n                  { initialValue: 'YES', rules: [{ required: true, message: '是否限制访问' }] },\n                ]"}],attrs:{placeholder:"是否限制访问"}},[t("a-select-option",{attrs:{value:"YES"}},[e._v(" 开启 ")]),t("a-select-option",{attrs:{value:"NO"}},[e._v(" 关闭 ")])],1)],1),t("a-form-item",{attrs:{label:"DB类型","has-feedback":""}},[t("a-select",{directives:[{name:"decorator",rawName:"v-decorator",value:["db_type",{initialValue:"MySQL",rules:[{required:!0,message:"请选择DB类型"}]}],expression:"[\n                  'db_type',\n                  { initialValue: 'MySQL', rules: [{ required: true, message: '请选择DB类型' }] },\n                ]"}],attrs:{placeholder:"请选择DB类型",allowClear:"","show-search":""},on:{change:e.changeDBType}},e._l(e.dbTypes,(function(r,a){return t("a-select-option",{key:a,attrs:{value:r}},[e._v(" "+e._s(r)+" ")])})),1)],1),t("a-form-item",{attrs:{label:"环境","has-feedback":""}},[t("a-select",{directives:[{name:"decorator",rawName:"v-decorator",value:["environment",{rules:[{required:!0,message:"请选择工单环境"}]}],expression:"['environment', { rules: [{ required: true, message: '请选择工单环境' }] }]"}],attrs:{placeholder:"请选择工单环境",allowClear:"","show-search":""},on:{change:e.changeEnvs}},e._l(e.environments,(function(r,a){return t("a-select-option",{key:a,attrs:{value:r.id}},[e._v(" "+e._s(r.name)+" ")])})),1)],1),t("a-form-item",{attrs:{label:"实例","has-feedback":""}},[t("a-select",{directives:[{name:"decorator",rawName:"v-decorator",value:["instance_id",{rules:[{required:!0,message:"请选择数据库实例"}]}],expression:"['instance_id', { rules: [{ required: true, message: '请选择数据库实例' }] }]"}],attrs:{placeholder:"请选择数据库实例",allowClear:"","show-search":""},on:{change:e.changeIns}},e._l(e.instances,(function(r,a){return t("a-select-option",{key:a,attrs:{value:r.instance_id}},[e._v(" "+e._s(r.remark)+" ")])})),1)],1),t("a-form-item",{attrs:{label:"库名","has-feedback":""}},[t("a-select",{directives:[{name:"decorator",rawName:"v-decorator",value:["schema",{rules:[{required:!0,message:"请选择数据库"}]}],expression:"['schema', { rules: [{ required: true, message: '请选择数据库' }] }]"}],attrs:{placeholder:"请选择数据库",allowClear:"","show-search":""}},e._l(e.schemas,(function(r,a){return t("a-select-option",{key:a,attrs:{value:r.schema}},[e._v(" "+e._s(r.schema)+" ")])})),1)],1),t("a-form-item",{directives:[{name:"show",rawName:"v-show",value:e.isExportOrder,expression:"isExportOrder"}],attrs:{label:"文件格式","has-feedback":""}},[t("a-select",{directives:[{name:"decorator",rawName:"v-decorator",value:["export_file_format",{initialValue:"XLSX",rules:[{required:!0,message:"请选择导出文件类型"}]}],expression:"['export_file_format', { initialValue: 'XLSX', rules: [{ required: true, message: '请选择导出文件类型' }] }]"}],attrs:{placeholder:"请选择导出文件类型",allowClear:"","show-search":""}},e._l(e.exportFileFormats,(function(r,a){return t("a-select-option",{key:a,attrs:{value:r}},[e._v(" "+e._s(r)+" ")])})),1)],1),t("a-form-item",{attrs:{label:"审核人",help:"请至少选择1位工单审核人","has-feedback":""}},[t("a-select",{directives:[{name:"decorator",rawName:"v-decorator",value:["approver",{rules:[{required:!0,message:"请选择工单审核人",validator:e.validatorApprover}]}],expression:"[\n                  'approver',\n                  { rules: [{ required: true, message: '请选择工单审核人', validator: validatorApprover }] },\n                ]"}],attrs:{placeholder:"请选择工单审核人",mode:"multiple",allowClear:"","show-search":""}},e._l(e.users,(function(r,a){return t("a-select-option",{key:a,attrs:{value:r.username}},[e._v(" "+e._s(r.username)+" "),t("strong",[e._v(e._s(r.nick_name))])])})),1)],1),t("a-form-item",{attrs:{label:"执行人",help:"请选择工单执行人","has-feedback":""}},[t("a-select",{directives:[{name:"decorator",rawName:"v-decorator",value:["executor",{rules:[{required:!0,message:"请选择工单执行人"}]}],expression:"['executor', { rules: [{ required: true, message: '请选择工单执行人' }] }]"}],attrs:{placeholder:"请选择工单执行人",mode:"multiple",allowClear:"","show-search":""}},e._l(e.users,(function(r,a){return t("a-select-option",{key:a,attrs:{value:r.username}},[e._v(" "+e._s(r.username)+" "),t("strong",[e._v(e._s(r.nick_name))])])})),1)],1),t("a-form-item",{attrs:{label:"复核人",help:"请选择工单执行后结果的复核人","has-feedback":""}},[t("a-select",{directives:[{name:"decorator",rawName:"v-decorator",value:["reviewer",{rules:[{required:!0,message:"请选择工单复核人"}]}],expression:"['reviewer', { rules: [{ required: true, message: '请选择工单复核人' }] }]"}],attrs:{placeholder:"请选择工单复核人",mode:"multiple",allowClear:"","show-search":""}},e._l(e.users,(function(r,a){return t("a-select-option",{key:a,attrs:{value:r.username}},[e._v(" "+e._s(r.username)+" "),t("strong",[e._v(e._s(r.nick_name))])])})),1)],1),t("a-form-item",{attrs:{label:"抄送人","has-feedback":""}},[t("a-select",{directives:[{name:"decorator",rawName:"v-decorator",value:["cc",{rules:[{required:!1,message:"请选择工单抄送人"}]}],expression:"['cc', { rules: [{ required: false, message: '请选择工单抄送人' }] }]"}],attrs:{placeholder:"请选择工单抄送人",mode:"multiple",allowClear:"","show-search":""}},e._l(e.users,(function(r,a){return t("a-select-option",{key:a,attrs:{value:r.username}},[e._v(" "+e._s(r.username)+" "),t("strong",[e._v(e._s(r.nick_name))])])})),1)],1),t("a-form-item",{attrs:{"wrapper-col":{span:12,offset:6}}},[t("a-button",{key:"submit",attrs:{type:"primary",loading:e.loading},on:{click:e.onSubmit}},[e._v(" 提交 ")])],1)],1)],1)],1),t("a-col",{staticClass:"gutter-row",attrs:{span:16}},[t("a-card",[t("a-alert",{attrs:{message:"支持多条SQL语句，每条SQL语句须以 ; 结尾",banner:"",closable:""}}),t("div",{staticStyle:{"margin-bottom":"5px","margin-top":"4px"}},[t("a-button",{attrs:{type:"dashed",icon:"thunderbolt"},on:{click:function(t){return e.formatSQL()}}},[e._v("格式化")]),t("a-button",{staticStyle:{"margin-right":"6px"},attrs:{type:"dashed",icon:"safety",disabled:e.checkBtnStatus},on:{click:function(t){return e.syntaxCheck()}}},[e._v("语法检查")])],1),t("codemirror",{ref:"myCm",attrs:{options:e.cmOptions},on:{ready:e.onCmReady},model:{value:e.code,callback:function(t){e.code=t},expression:"code"}})],1)],1)],1)],1),e.visibleAuditResult?t("a-card",[t("AuditResultComponent",{ref:"AuditResultComponent"})],1):e._e()],1)},s=[],n=(r(41539),r(54086),r(20017),r(21994),r(71707),r(48991),r(3585),r(14504),r(4328),r(82801),r(23412),r(3439)),i=r(72701),o=function(){var e=this,t=e._self._c;return t("a-row",[t("a-table",{attrs:{columns:e.tableColumns,dataSource:e.tableData,pagination:e.pagination,loading:e.tableLoading,rowClassName:e.setRowClass,rowKey:function(e,t){return t},size:"middle"},on:{change:e.handleTableChange},scopedSlots:e._u([{key:"summary",fn:function(r){return e._l(r,(function(r,a){return t("ul",{key:a,staticStyle:{"list-style-type":"square",padding:"0 0 0 16px",margin:"2px"}},[t("li",[e._v(e._s(r))])])}))}}])})],1)},l=[],u=[{title:"指纹",dataIndex:"finger_id",key:"finger_id",width:"15%",scopedSlots:{customRender:"finger_id"}},{title:"级别",dataIndex:"level",key:"level",ellipsis:!0,scopedSlots:{customRender:"level"}},{title:"语句",dataIndex:"query",key:"query",width:"30%",ellipsis:!0,scopedSlots:{customRender:"query"}},{title:"提示",dataIndex:"summary",key:"summary",width:"40%",scopedSlots:{customRender:"summary"}},{title:"类型",dataIndex:"type",key:"type",scopedSlots:{customRender:"type"}}],c={data:function(){return{tableLoading:!1,tableColumns:u,tableData:[],pagination:{current:1,pageSize:10,total:0,pageSizeOptions:["10","20","50"],showSizeChanger:!0}}},methods:{setRowClass:function(e){return"INFO"===e.level?"row-level-info":"WARN"===e.level?"row-level-warn":"ERROR"===e.level?"row-level-error":void 0},renderData:function(e){0===e.status&&this.$notification.success({message:"成功",description:"语法检查通过，您可以提交工单了，O(∩_∩)O"}),1===e.status&&this.$notification.warning({message:"警告",description:"语法检查未通过，请根据下面输出提示进行更正，(ㄒoㄒ)"}),this.tableData=e.data},handleTableChange:function(e){this.pagination.current=e.current,this.pagination.pageSize=e.pageSize}}},d=c,m=r(1001),p=(0,m.Z)(d,o,l,!1,null,null,null),h=p.exports,f=["MySQL","TiDB"],v=["XLSX","CSV"],g={components:{AuditResultComponent:h},computed:{codemirror:function(){return this.$refs.myCm.codemirror},isExportOrder:function(){return"export"===this.sqlType.toLowerCase()}},data:function(){return{loading:!1,checkBtnStatus:!1,visibleAuditResult:!1,sqlType:"",cardTitle:"",dbTypes:f,exportFileFormats:v,environments:[],instances:[],schemas:[],users:[],form:this.$form.createForm(this,{name:"commit"}),code:"",cmOptions:{mode:"text/x-mysql",indentUnit:2,tabSize:2,indentWithTabs:!0,smartIndent:!0,autoRefresh:!0,lineNumbers:!0,styleActiveLine:!0,autoCloseBrackets:!0,matchBrackets:!0,lineWrapping:!0,autofocus:!0,resetSelectionOnContextMenu:!1,showCursorWhenSelecting:!0,keyMap:"sublime"},validatorApprover:function(e,t,r){return t.length<1?r("请至少选择1位工单审核人"):t.length>=3?r("最大不允许超过3位工单审核人"):void r()}}},methods:{handleApproverChange:function(e){if(e.length<2)return!1},getSqlType:function(){var e=this.$route.path.split("/").pop().toUpperCase();this.sqlType=e,this.cardTitle="提交".concat(this.sqlType,"工单")},onCmReady:function(e){var t=this.$refs.formHeight.$el.offsetHeight-55;e.setSize("height","".concat(t,"px")),e.on("keypress",(function(){e.showHint({completeSingle:!1})}))},formatSQL:function(){var e=this.codemirror.getValue();this.codemirror.setValue((0,n.WU)(e,{language:"mysql"}))},getEnvironments:function(){var e=this;(0,i.hS)({is_page:!1}).then((function(t){e.environments=t.data})).catch((function(e){}))},changeDBType:function(){this.form.resetFields(["environment","instance_id","schema"])},changeEnvs:function(e){var t=this;this.form.resetFields(["instance_id","schema"]);var r={id:e,db_type:this.form.getFieldValue("db_type"),is_page:!1};(0,i.E5)(r).then((function(e){t.instances=e.data})).catch((function(e){}))},changeIns:function(e){var t=this;this.form.resetFields(["schema"]);var r={instance_id:e,is_page:!1};(0,i.gg)(r).then((function(e){t.schemas=e.data})).catch((function(e){}))},getUsers:function(){var e=this,t={is_page:!1};(0,i.xE)(t).then((function(t){e.users=t.data})).catch((function(e){}))},syntaxCheck:function(){var e=this,t=this.codemirror.getValue();if(""!==t)if(this.form.getFieldValue("environment"))if(this.form.getFieldValue("instance_id"))if(this.form.getFieldValue("schema")){this.$notification.info({message:"提示",description:"开始执行语法检查"});var r={db_type:this.form.getFieldValue("db_type"),sql_type:this.sqlType,instance_id:this.form.getFieldValue("instance_id"),schema:this.form.getFieldValue("schema"),content:this.codemirror.getValue()};this.$nextTick((function(){document.scrollingElement.scrollTop=document.scrollingElement.scrollHeight})),this.checkBtnStatus=!0,(0,i.u7)(r).then((function(t){"0000"===t.code?"export"===r["sql_type"].toLowerCase()?e.$notification.success({message:"成功",description:"语法检查通过，您可以提交工单了，(⊙o⊙)"}):(e.visibleAuditResult=!0,e.$nextTick((function(){e.$refs.AuditResultComponent.renderData(t.data)}))):(e.visibleAuditResult=!1,e.$notification.error({message:"错误",description:t.message}))})).catch((function(e){})).finally((function(){e.checkBtnStatus=!1}))}else this.$notification.warning({message:"警告",description:"请选择库名"});else this.$notification.warning({message:"警告",description:"请选择实例"});else this.$notification.warning({message:"警告",description:"请选择环境"});else this.$notification.warning({message:"警告",description:"输入内容不能为空"})},onSubmit:function(e){var t=this;this.loading=!0,this.disableCommit=!1,e.preventDefault(),this.form.validateFields((function(e,r){if(e)t.$notification.error({message:"错误",description:e});else{var a=t.codemirror.getValue();""!==a?(r["is_restrict_access"]="YES"===r["is_restrict_access"],r["content"]=a,r["sql_type"]=t.sqlType,(0,i.M0)(r).then((function(e){"0000"===e.code?t.$router.push("/orders/list"):t.$notification.warning({message:"警告",description:e.message})})).catch((function(e){})).finally((function(){t.disableCommit=!1}))):t.$notification.error({message:"错误",description:"提交的SQL内容不能为空"})}})),this.loading=!1,this.disableCommit=!1}},mounted:function(){this.getSqlType(),this.getEnvironments(),this.getUsers()},watch:{$route:function(){this.getSqlType()}}},_=g,y=(0,m.Z)(_,a,s,!1,null,"51c5a421",null),b=y.exports},72701:function(e,t,r){r.d(t,{$W:function(){return y},E5:function(){return n},EE:function(){return v},M0:function(){return u},QU:function(){return m},Xu:function(){return d},ci:function(){return g},eU:function(){return p},el:function(){return c},gc:function(){return b},gg:function(){return i},hS:function(){return s},jb:function(){return w},kK:function(){return q},l5:function(){return _},pl:function(){return h},u7:function(){return l},um:function(){return f},xE:function(){return o},xZ:function(){return k}});var a=r(34820),s=function(e){return a.ZP.request({url:"/api/v1/orders/environments",method:"get",params:e})},n=function(e){return a.ZP.request({url:"/api/v1/orders/instances",method:"get",params:e})},i=function(e){return a.ZP.request({url:"/api/v1/orders/schemas",method:"get",params:e})},o=function(e){return a.ZP.request({url:"/api/v1/orders/users",method:"get",params:e})},l=function(e){return a.ZP.request({url:"/api/v1/orders/syntax-inspect",method:"post",data:e})},u=function(e){return a.ZP.request({url:"/api/v1/orders/commit",method:"post",data:e})},c=function(e){return a.ZP.request({url:"/api/v1/orders/list",method:"get",params:e})},d=function(e){return a.ZP.request({url:"/api/v1/orders/detail/".concat(e),method:"get",params:e})},m=function(e){return a.ZP.request({url:"/api/v1/orders/detail/oplogs",method:"get",params:e})},p=function(e){return a.ZP.request({url:"/api/v1/orders/operate/approve",method:"put",data:e})},h=function(e){return a.ZP.request({url:"/api/v1/orders/operate/feedback",method:"put",data:e})},f=function(e){return a.ZP.request({url:"/api/v1/orders/operate/review",method:"put",data:e})},v=function(e){return a.ZP.request({url:"/api/v1/orders/operate/close",method:"put",data:e})},g=function(e){return a.ZP.request({url:"/api/v1/orders/hook",method:"post",data:e})},_=function(e){return a.ZP.request({url:"/api/v1/orders/generate-tasks",method:"post",data:e})},y=function(e){return a.ZP.request({url:"/api/v1/orders/tasks/".concat(e.order_id),method:"get",params:e})},b=function(e){return a.ZP.request({url:"/api/v1/orders/tasks/preview",method:"get",params:e})},w=function(e){return a.ZP.request({url:"/api/v1/orders/tasks/execute-single",method:"post",data:e})},k=function(e){return a.ZP.request({url:"/api/v1/orders/tasks/execute-all",method:"post",data:e})},q=function(e){return a.ZP.request({url:"/api/v1/orders/download/exportfile/".concat(e),method:"get",responseType:"blob"})}}}]);