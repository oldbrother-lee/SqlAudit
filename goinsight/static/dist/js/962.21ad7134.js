(self["webpackChunkvue_antd_pro"]=self["webpackChunkvue_antd_pro"]||[]).push([[962],{45962:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return M}});var s=function(){var e=this,t=e._self._c;return t("div",[t("a-card",{attrs:{title:"SQL执行任务"}},[t("a-form",{attrs:{layout:"inline",form:e.form},nativeOn:{keyup:function(t){return!t.type.indexOf("key")&&e._k(t.keyCode,"enter",13,t.key,"Enter")?null:e.handleSearch.apply(null,arguments)}}},[t("a-form-item",[t("a-button",{attrs:{icon:"play-circle"},on:{click:function(t){return e.executeMTask()}}},[e._v("全部执行")])],1),t("a-form-item",[t("a-select",{directives:[{name:"decorator",rawName:"v-decorator",value:["progress"],expression:"['progress']"}],staticStyle:{width:"150px"},attrs:{allowClear:"",placeholder:"请选择进度","show-search":""}},e._l(e.progs,(function(r){return t("a-select-option",{key:r,attrs:{value:r}},[e._v(e._s(r))])})),1)],1),t("a-form-item",[t("a-input-search",{directives:[{name:"decorator",rawName:"v-decorator",value:["search"],expression:"['search']"}],staticStyle:{width:"250px"},attrs:{allowClear:"",placeholder:"输入要查询SQL内容"}})],1),t("a-form-item",[t("span",{staticClass:"table-page-search-submitButtons"},[t("a-button",{attrs:{type:"primary"},on:{click:e.handleSearch}},[e._v("查询")])],1)])],1),t("a-table",{attrs:{columns:e.tableColumns,rowKey:function(e,t){return t},dataSource:e.tableData,pagination:e.pagination,loading:e.loading},on:{change:e.handleTableChange},scopedSlots:e._u([{key:"sql",fn:function(r){return t("span",{},[t("a-tooltip",{attrs:{placement:"topLeft"}},[t("template",{slot:"title"},[e._v(e._s(r))]),t("span",{attrs:{href:"#"}},[e._v(e._s(r))])],2)],1)}},{key:"progress",fn:function(r){return t("span",{},["执行中"===r?t("span",{staticStyle:{color:"orange"}},[e._v(e._s(r))]):"已完成"===r?t("span",{staticStyle:{color:"green"}},[e._v(e._s(r))]):"已失败"===r?t("span",{staticStyle:{color:"red"}},[e._v(e._s(r))]):"已暂停"===r?t("span",{staticStyle:{color:"blue"}},[e._v(e._s(r))]):t("span",[e._v(e._s(r))])])}},{key:"action",fn:function(r,s){return t("span",{},[t("div",{staticClass:"editable-row-operations"},[t("a",{on:{click:function(){return e.executeSTask(s)}}},[t("span",{staticStyle:{color:"#409eff"}},[e._v("执行")])]),t("a-divider",{attrs:{type:"vertical"}}),t("a",{attrs:{type:"dashed"},on:{click:function(t){return e.viewResult(s)}}},[t("span",{staticStyle:{color:"#409eff"}},[e._v("结果")])])],1)])}}])})],1),t("TasksResultComponent",{ref:"TasksResultComponent"}),t("TasksWebsocketComponent",{ref:"TasksWebsocketComponent"})],1)},o=[],n=r(23711),a=(r(74916),r(64765),r(41539),r(72701)),i=function(){var e=this,t=e._self._c;return t("a-modal",{attrs:{title:"执行详情",width:"50%"},model:{value:e.visible,callback:function(t){e.visible=t},expression:"visible"}},[t("template",{slot:"footer"},[t("a-button",{key:"back",on:{click:e.handleCancel}},[e._v(" 关闭 ")])],1),t("a-card",{attrs:{size:"small",title:"执行信息"}},[t("a-row",{attrs:{gutter:16}},[t("a-col",{attrs:{span:8}},[t("a-statistic",{staticClass:"demo-class",attrs:{title:"执行耗时",value:e.executeResult.execute_cost_time}})],1),t("a-col",{attrs:{span:8}},[t("a-statistic",{staticClass:"demo-class",attrs:{title:"备份耗时",value:e.executeResult.backup_cost_time}})],1),t("a-col",{attrs:{span:8}},[t("a-statistic",{staticStyle:{"margin-right":"50px"},attrs:{title:"影响行数",value:e.executeResult.affected_rows}})],1)],1)],1),t("a-card",{directives:[{name:"show",rawName:"v-show",value:"EXPORT"===e.sql_type,expression:"sql_type === 'EXPORT'"}],staticStyle:{"margin-top":"8px"},attrs:{size:"small",title:"导出文件信息"}},[t("a-row",{attrs:{gutter:16}},[t("a-col",{attrs:{span:24}},[t("a-statistic",{attrs:{title:"文件名",value:e.executeResult.file_name}})],1),t("a-col",{attrs:{span:24}},[t("a-statistic",{attrs:{title:"文件大小（字节）",value:e.executeResult.file_size}})],1),t("a-col",{attrs:{span:24}},[t("a-statistic",{attrs:{title:"导出行数",value:e.executeResult.export_rows}})],1),t("a-col",{attrs:{span:24}},[t("a-statistic",{attrs:{title:"文件加密秘钥",value:e.executeResult.encryption_key}})],1),t("a-col",{attrs:{span:24}},[t("a-statistic",{attrs:{title:"文件下载路径",value:e.executeResult.download_url}})],1)],1)],1),t("a-card",{directives:[{name:"show",rawName:"v-show",value:""!=e.executeResult.error,expression:"executeResult.error != ''"}],staticStyle:{"margin-top":"6px"},attrs:{size:"small",title:"错误信息"}},[t("TaskCodeMirrorComponent",{ref:"ErrorCodeMirrorComponent"})],1),t("a-card",{directives:[{name:"show",rawName:"v-show",value:""!=e.executeResult.execute_log,expression:"executeResult.execute_log != ''"}],staticStyle:{"margin-top":"6px"},attrs:{size:"small",title:"执行日志"}},[t("TaskCodeMirrorComponent",{ref:"LogCodeMirrorComponent"})],1),t("a-card",{directives:[{name:"show",rawName:"v-show",value:""!=e.executeResult.rollback_sql,expression:"executeResult.rollback_sql != ''"}],staticStyle:{"margin-top":"6px"},attrs:{size:"small",title:"回滚SQL"}},[t("TaskCodeMirrorComponent",{ref:"RollbackCodeMirrorComponent"})],1)],2)},u=[],c=function(){var e=this,t=e._self._c;return t("codemirror",{ref:"myCm",attrs:{options:e.cmOptions},on:{ready:e.onCmReady},model:{value:e.code,callback:function(t){e.code=t},expression:"code"}})},l=[],d=(r(14504),r(21994),r(82801),r(4328),r(14146),r(20017),r(54086),{data:function(){return{code:"",cmOptions:{mode:"text/x-mysql",indentUnit:2,tabSize:2,indentWithTabs:!0,smartIndent:!0,autoRefresh:!0,lineNumbers:!0,lineWrapping:!0,readOnly:!0,focuse:!1}}},methods:{onCmReady:function(e){e.setSize("height","260px")},setValue:function(e){this.codemirror.setValue(e)},setSize:function(e,t){this.codemirror.setSize(e,t)}},computed:{codemirror:function(){return this.$refs.myCm.codemirror}}}),p=d,m=r(1001),f=(0,m.Z)(p,c,l,!1,null,null,null),h=f.exports,v={components:{TaskCodeMirrorComponent:h},data:function(){return{visible:!1,executeResult:{},sql_type:""}},methods:{showModal:function(e){var t=this;this.visible=!0,this.executeResult=e.result,this.sql_type=e.sql_type,null!=this.executeResult&&this.$nextTick((function(){t.$refs.RollbackCodeMirrorComponent.setValue(t.executeResult.rollback_sql),t.$refs.LogCodeMirrorComponent.setValue(t.executeResult.execute_log),null!=t.executeResult.error&&t.$refs.ErrorCodeMirrorComponent.setValue(t.executeResult.error)}))},handleCancel:function(e){this.visible=!1}}},k=v,g=(0,m.Z)(k,i,u,!1,null,"4a93f344",null),b=g.exports,y=function(){var e=this,t=e._self._c;return t("a-card",{directives:[{name:"show",rawName:"v-show",value:e.executeMsgVisible,expression:"executeMsgVisible"}],staticStyle:{"margin-top":"8px"},attrs:{title:e.bindTitle}},[t("codemirror",{ref:"myCm",attrs:{options:e.cmOptions},on:{ready:e.onCmReady},model:{value:e.code,callback:function(t){e.code=t},expression:"code"}})],1)},x=[],_=(r(92222),r(47941),"ws://");"https:"===window.location.protocol&&(_="wss://");var C={data:function(){return{bindTitle:"",websocket:{path:"".concat(_,"/").concat(window.location.host,"/ws/").concat(this.$route.params.order_id),socket:""},executeMsgVisible:!1,code:"",cmOptions:{indentUnit:2,tabSize:2,indentWithTabs:!0,smartIndent:!0,autoRefresh:!0,lineWrapping:!0,readOnly:!0,focuse:!1}}},methods:{onCmReady:function(e){e.setSize("height","450px")},initWebsocket:function(){"undefined"===typeof WebSocket&&this.$message.error("您的浏览器不支持websocket"),this.websocket.socket=new WebSocket(this.websocket.path),this.websocket.socket.onopen=this.socketOnOpen,this.websocket.socket.onerror=this.socketOnError,this.websocket.socket.onmessage=this.socketOnMessage},socketOnOpen:function(){},socketOnError:function(){var e=this;setTimeout((function(){e.initWebsocket()}),3e3)},socketOnMessage:function(e){var t=this,r=JSON.parse(e.data);if(this.executeMsgVisible=!0,"processlist"===r.type)this.codemirror.setValue(this.renderProcesslist(r.data));else if("ghost"===r.type){var s=this.codemirror.getCursor(this.codemirror.lastLine());this.codemirror.replaceRange(r.data,s),this.$nextTick((function(){t.codemirror.setCursor(t.codemirror.lastLine())}))}else this.codemirror.setValue(r.data)},socketClose:function(){this.websocket.socket.close()},renderProcesslist:function(e){this.bindTitle="当前SQL SESSION ID的SHOW PROCESSLIST输出";var t="";for(var r in e)t+=r+": "+e[r]+"\n";return t}},destroyed:function(){this.socketClose()},computed:{codemirror:function(){return this.$refs.myCm.codemirror}},mounted:function(){this.initWebsocket()}},S=C,w=(0,m.Z)(S,y,x,!1,null,null,null),R=w.exports,P=[{title:"进度",dataIndex:"progress",key:"progress",width:"10%",scopedSlots:{customRender:"progress"}},{title:"TaskID",dataIndex:"task_id",key:"task_id",width:"20%",scopedSlots:{customRender:"task_id"}},{title:"SQL文本",dataIndex:"sql",key:"sql",ellipsis:!0,width:"35%",scopedSlots:{customRender:"sql"}},{title:"更新时间",dataIndex:"updated_at",key:"updated_at",ellipsis:!0,scopedSlots:{customRender:"updated_at"}},{title:"操作",dataIndex:"action",key:"action",scopedSlots:{customRender:"action"}}],T={components:{TasksWebsocketComponent:R,TasksResultComponent:b},data:function(){return{loading:!1,progs:["未执行","执行中","已完成","已失败","已暂停"],tableColumns:P,tableData:[],pagination:{current:1,pageSize:10,total:0,pageSizeOptions:["10","20","50","100"],showSizeChanger:!0},form:this.$form.createForm(this,{name:"tasks"})}},methods:{handleTableChange:function(e){this.pagination.current=e.current,this.pagination.pageSize=e.pageSize,this.getTasks()},handleSearch:function(e){var t=this;e.preventDefault(),this.form.validateFields((function(e,r){e||(t.filters=(0,n.Z)({search:r["search"]},r),t.pagination.current=1,t.getTasks())}))},getTasks:function(){var e=this;this.loading=!0;var t=(0,n.Z)({page_size:this.pagination.pageSize,page:this.pagination.current,is_page:!0,order_id:this.$route.params.order_id},this.filters);(0,a.$W)(t).then((function(t){"0000"===t.code&&(e.pagination.total=t.total,e.tableData=t.data)})).catch((function(e){})).finally((function(){e.loading=!1}))},executeSTask:function(e){var t=this;this.$notification.info({message:"提示",description:"开始执行任务，请查看输出"});var r={id:e.id,order_id:this.$route.params.order_id};(0,a.jb)(r).then((function(e){"0001"===e.code&&t.$notification.error({message:"错误",description:e.message}),t.getTasks()})).catch((function(e){}))},executeMTask:function(){var e=this;this.$notification.info({message:"提示",description:"开始执行任务，请查看输出"});var t={order_id:this.$route.params.order_id};(0,a.xZ)(t).then((function(t){"0001"===t.code&&e.$notification.error({message:"错误",description:t.message}),e.getTasks()})).catch((function(e){}))},viewResult:function(e){["已完成","已失败"].indexOf(e.progress)>=0?this.$refs.TasksResultComponent.showModal(e):this.$notification.warning({message:"警告",description:"当前任务状态不为【已完成】或【已失败】"})}},mounted:function(){this.getTasks()}},q=T,Z=(0,m.Z)(q,s,o,!1,null,"7874f885",null),M=Z.exports},72701:function(e,t,r){"use strict";r.d(t,{$W:function(){return b},E5:function(){return n},EE:function(){return v},M0:function(){return c},QU:function(){return p},Xu:function(){return d},ci:function(){return k},eU:function(){return m},el:function(){return l},gc:function(){return y},gg:function(){return a},hS:function(){return o},jb:function(){return x},kK:function(){return C},l5:function(){return g},pl:function(){return f},u7:function(){return u},um:function(){return h},xE:function(){return i},xZ:function(){return _}});var s=r(34820),o=function(e){return s.ZP.request({url:"/api/v1/orders/environments",method:"get",params:e})},n=function(e){return s.ZP.request({url:"/api/v1/orders/instances",method:"get",params:e})},a=function(e){return s.ZP.request({url:"/api/v1/orders/schemas",method:"get",params:e})},i=function(e){return s.ZP.request({url:"/api/v1/orders/users",method:"get",params:e})},u=function(e){return s.ZP.request({url:"/api/v1/orders/syntax-inspect",method:"post",data:e})},c=function(e){return s.ZP.request({url:"/api/v1/orders/commit",method:"post",data:e})},l=function(e){return s.ZP.request({url:"/api/v1/orders/list",method:"get",params:e})},d=function(e){return s.ZP.request({url:"/api/v1/orders/detail/".concat(e),method:"get",params:e})},p=function(e){return s.ZP.request({url:"/api/v1/orders/detail/oplogs",method:"get",params:e})},m=function(e){return s.ZP.request({url:"/api/v1/orders/operate/approve",method:"put",data:e})},f=function(e){return s.ZP.request({url:"/api/v1/orders/operate/feedback",method:"put",data:e})},h=function(e){return s.ZP.request({url:"/api/v1/orders/operate/review",method:"put",data:e})},v=function(e){return s.ZP.request({url:"/api/v1/orders/operate/close",method:"put",data:e})},k=function(e){return s.ZP.request({url:"/api/v1/orders/hook",method:"post",data:e})},g=function(e){return s.ZP.request({url:"/api/v1/orders/generate-tasks",method:"post",data:e})},b=function(e){return s.ZP.request({url:"/api/v1/orders/tasks/".concat(e.order_id),method:"get",params:e})},y=function(e){return s.ZP.request({url:"/api/v1/orders/tasks/preview",method:"get",params:e})},x=function(e){return s.ZP.request({url:"/api/v1/orders/tasks/execute-single",method:"post",data:e})},_=function(e){return s.ZP.request({url:"/api/v1/orders/tasks/execute-all",method:"post",data:e})},C=function(e){return s.ZP.request({url:"/api/v1/orders/download/exportfile/".concat(e),method:"get",responseType:"blob"})}},14146:function(e,t,r){(function(e){e(r(4631))})((function(e){"use strict";e.overlayMode=function(t,r,s){return{startState:function(){return{base:e.startState(t),overlay:e.startState(r),basePos:0,baseCur:null,overlayPos:0,overlayCur:null,streamSeen:null}},copyState:function(s){return{base:e.copyState(t,s.base),overlay:e.copyState(r,s.overlay),basePos:s.basePos,baseCur:null,overlayPos:s.overlayPos,overlayCur:null}},token:function(e,o){return(e!=o.streamSeen||Math.min(o.basePos,o.overlayPos)<e.start)&&(o.streamSeen=e,o.basePos=o.overlayPos=e.start),e.start==o.basePos&&(o.baseCur=t.token(e,o.base),o.basePos=e.pos),e.start==o.overlayPos&&(e.pos=e.start,o.overlayCur=r.token(e,o.overlay),o.overlayPos=e.pos),e.pos=Math.min(o.basePos,o.overlayPos),null==o.overlayCur?o.baseCur:null!=o.baseCur&&o.overlay.combineTokens||s&&null==o.overlay.combineTokens?o.baseCur+" "+o.overlayCur:o.overlayCur},indent:t.indent&&function(e,r,s){return t.indent(e.base,r,s)},electricChars:t.electricChars,innerMode:function(e){return{state:e.base,mode:t}},blankLine:function(e){var o,n;return t.blankLine&&(o=t.blankLine(e.base)),r.blankLine&&(n=r.blankLine(e.overlay)),null==n?o:s&&null!=o?o+" "+n:n}}}}))}}]);